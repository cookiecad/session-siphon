services:
  typesense:
    image: typesense/typesense:27.1
    restart: unless-stopped
    volumes:
      - ./data/typesense:/data
    command: >
      --data-dir=/data
      --api-key=${TYPESENSE_API_KEY:-dev-api-key}
    environment:
      - TYPESENSE_API_KEY=${TYPESENSE_API_KEY:-dev-api-key}

  processor:
    image: ${PROCESSOR_IMAGE:-ghcr.io/cookiecad/session-siphon-processor}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.processor
    restart: unless-stopped
    volumes:
      - ./data/session-siphon:/data/session-siphon
    environment:
      - TYPESENSE_API_KEY=${TYPESENSE_API_KEY:-dev-api-key}
      - TYPESENSE_HOST=typesense
      - TYPESENSE_PORT=8108
      - TYPESENSE_PROTOCOL=http
    depends_on:
      - typesense

  ui:
    image: ${UI_IMAGE:-ghcr.io/cookiecad/session-siphon-ui}:${IMAGE_TAG:-latest}
    build:
      context: ./ui
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${UI_PORT:-3000}:3000"
    environment:
      - TYPESENSE_API_KEY=${TYPESENSE_API_KEY:-dev-api-key}
      - TYPESENSE_HOST=typesense
      - TYPESENSE_PORT=8108
      - TYPESENSE_PROTOCOL=http
    depends_on:
      - typesense
